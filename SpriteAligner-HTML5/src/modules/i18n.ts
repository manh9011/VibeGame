export type Locale = "en" | "vi" | "zh-CN" | "zh-TW" | "fr" | "ru";

export interface LanguageOption {
    code: Locale;
    label: string;
}

export interface I18nApi {
    t: (key: string) => string;
    getLocale: () => Locale;
    setLocale: (locale: Locale) => void;
    applyTranslations: (root?: ParentNode) => void;
    setLanguageSelect: (select: HTMLSelectElement, onChange?: () => void) => void;
}

const STORAGE_KEY = "sprite-aligner-language";
const DEFAULT_LOCALE: Locale = "en";
const LOCALES: Locale[] = ["en", "vi", "zh-CN", "zh-TW", "fr", "ru"];

const LANGUAGE_OPTIONS: LanguageOption[] = [
    { code: "en", label: "English" },
    { code: "vi", label: "Tiếng Việt" },
    { code: "zh-CN", label: "简体中文" },
    { code: "zh-TW", label: "繁體中文" },
    { code: "fr", label: "Français" },
    { code: "ru", label: "Русский" },
];

const TRANSLATIONS: Record<Locale, Record<string, string>> = {
    "en": {
        "app.pageTitle": "Sprite Sheet Aligner Pro (Pixel Mode)",
        "app.title": "Sprite Aligner",
        "buttons.uploadImage": "Upload Image",
        "labels.columns": "Columns (C)",
        "labels.rows": "Rows (R)",
        "buttons.set": "Set",
        "labels.iso": "Isometric Grid",
        "labels.grid": "Grid",
        "labels.width": "Width",
        "labels.height": "Height",
        "labels.anchor": "Anchor Point",
        "labels.anchorMode": "Mode",
        "labels.anchorRatio": "Ratio",
        "labels.anchorPixel": "Pixel (px)",
        "labels.anchorXTitle": "X anchor (ratio or px)",
        "labels.anchorYTitle": "Y anchor (ratio or px)",
        "buttons.update": "Update",
        "buttons.undo": "Undo",
        "buttons.redo": "Redo",
        "buttons.orderHistoryNewest": "Sort: Newest first",
        "buttons.orderHistoryOldest": "Sort: Oldest first",
        "buttons.clearHistory": "Clear history",
        "labels.pixelMode": "Pixel Mode",
        "labels.showShortcuts": "Show Shortcuts",
        "buttons.resetAll": "Reset All",
        "buttons.export": "Export",
        "menu.edit": "Edit cell",
        "menu.copy": "Copy cell",
        "menu.paste": "Paste cell",
        "editor.title": "Edit cell",
        "editor.pan": "Pan",
        "editor.pencil": "Pencil",
        "editor.eraser": "Eraser",
        "editor.fill": "Fill",
        "editor.select": "Select",
        "editor.color": "Color",
        "editor.colorRight": "Right color",
        "editor.size": "Size",
        "editor.size1": "Size 1px",
        "editor.size2": "Size 2px",
        "editor.size3": "Size 3px",
        "editor.size4": "Size 4px",
        "editor.size5": "Size 5px",
        "editor.size6": "Size 6px",
        "editor.size7": "Size 7px",
        "editor.size8": "Size 8px",
        "editor.size9": "Size 9px",
        "editor.palette": "Palette",
        "editor.paletteMode": "Palette",
        "editor.paletteImage": "Image palette",
        "editor.paletteBasic": "Basic",
        "editor.paletteWarm": "Warm",
        "editor.paletteCool": "Cool",
        "editor.palettePastel": "Pastel",
        "editor.paletteMono": "Mono",
        "editor.patterns": "Fill patterns",
        "editor.shapes": "Shapes",
        "editor.save": "Save",
        "editor.undo": "Undo",
        "editor.redo": "Redo",
        "editor.maximize": "Maximize",
        "editor.restore": "Restore",
        "editor.cancel": "Cancel",
        "editor.deleteSelection": "Delete selection",
        "history.edit": "Edit cell",
        "overlay.resetCell": "Reset",
        "overlay.reorder": "Drag to reorder",
        "overlay.delete": "Delete cell",
        "overlay.copy": "Copy cell",
        "overlay.paste": "Paste cell",
        "shortcuts.zoom": "<strong>Scroll</strong>: Zoom View",
        "shortcuts.pan": "<strong>Space + Drag</strong>: Pan View",
        "shortcuts.delete": "<strong>Delete</strong>: Remove Cell",
        "shortcuts.nudge": "<strong>Arrows</strong>: Nudge 1px",
        "intro.title": "Upload an image to begin",
        "intro.subtitle": "Supports any image size",
        "confirm.applyGrid": "Changing the grid will reset sprite positions. Continue?",
        "confirm.deleteCell": "Delete this cell and shift the next cells to fill it?",
        "confirm.resetAll": "Reset all positions to default?",
        "confirm.clearHistory": "Clear all history entries?",
        "history.load": "Load image",
        "history.move": "Move",
        "history.scale": "Scale",
        "history.resetCell": "Reset cell",
        "history.reorder": "Reorder",
        "history.deleteCell": "Delete cell",
        "history.paste": "Paste cell",
        "history.empty": "No history yet",
        "history.applyGrid": "Apply grid",
        "history.resetAll": "Reset all",
        "labels.language": "Language",
        "labels.history": "History",
        "iso.gridTitle": "Grid size (e.g., 6x6)",
        "aria.languageSelect": "Language",
        "aria.historyList": "History list",
        "aria.undo": "Undo",
        "aria.redo": "Redo",
        "aria.orderHistory": "Sort history",
        "aria.clearHistory": "Clear history",
        "aria.resetCell": "Reset cell",
        "aria.copyCell": "Copy cell",
        "aria.pasteCell": "Paste cell",
        "aria.deleteCell": "Delete cell",
        "aria.reorderCell": "Reorder cell",
    },
    "vi": {
        "app.pageTitle": "Trình Căn Chỉnh Sprite (Chế Độ Pixel)",
        "app.title": "Căn Chỉnh Sprite",
        "buttons.uploadImage": "Tải Ảnh",
        "labels.columns": "Cột (C)",
        "labels.rows": "Hàng (R)",
        "buttons.set": "Đặt",
        "labels.iso": "Lưới Isometric",
        "labels.grid": "Lưới",
        "labels.width": "Rộng",
        "labels.height": "Cao",
        "labels.anchor": "Điểm neo",
        "labels.anchorMode": "Chế độ",
        "labels.anchorRatio": "Tỷ lệ",
        "labels.anchorPixel": "Pixel (px)",
        "labels.anchorXTitle": "Tọa độ X (tỷ lệ hoặc px)",
        "labels.anchorYTitle": "Tọa độ Y (tỷ lệ hoặc px)",
        "buttons.update": "Cập nhật",
        "buttons.undo": "Hoàn tác",
        "buttons.redo": "Làm lại",
        "buttons.orderHistoryNewest": "Sắp xếp: Mới nhất trước",
        "buttons.orderHistoryOldest": "Sắp xếp: Cũ nhất trước",
        "buttons.clearHistory": "Xóa lịch sử",
        "labels.pixelMode": "Chế độ Pixel",
        "labels.showShortcuts": "Hiện phím tắt",
        "buttons.resetAll": "Đặt lại tất cả",
        "buttons.export": "Xuất",
        "menu.edit": "Sửa ô",
        "menu.copy": "Sao chép ô",
        "menu.paste": "Dán ô",
        "editor.title": "Sửa ô",
        "editor.pan": "Di chuyển",
        "editor.pencil": "Bút chì",
        "editor.eraser": "Tẩy",
        "editor.fill": "Đổ màu",
        "editor.select": "Chọn vùng",
        "editor.color": "Màu",
        "editor.colorRight": "Màu phải",
        "editor.size": "Cỡ",
        "editor.size1": "Cỡ 1px",
        "editor.size2": "Cỡ 2px",
        "editor.size3": "Cỡ 3px",
        "editor.size4": "Cỡ 4px",
        "editor.size5": "Cỡ 5px",
        "editor.size6": "Cỡ 6px",
        "editor.size7": "Cỡ 7px",
        "editor.size8": "Cỡ 8px",
        "editor.size9": "Cỡ 9px",
        "editor.palette": "Bảng màu",
        "editor.paletteMode": "Bảng màu",
        "editor.paletteImage": "Theo ảnh",
        "editor.paletteBasic": "Cơ bản",
        "editor.paletteWarm": "Ấm",
        "editor.paletteCool": "Lạnh",
        "editor.palettePastel": "Pastel",
        "editor.paletteMono": "Đơn sắc",
        "editor.patterns": "Hoa văn tô",
        "editor.shapes": "Hình vẽ",
        "editor.save": "Lưu",
        "editor.undo": "Hoàn tác",
        "editor.redo": "Làm lại",
        "editor.maximize": "Phóng to",
        "editor.restore": "Thu nhỏ",
        "editor.cancel": "Hủy",
        "editor.deleteSelection": "Xóa vùng chọn",
        "history.edit": "Sửa ô",
        "overlay.resetCell": "Đặt lại",
        "overlay.reorder": "Kéo để sắp xếp",
        "overlay.delete": "Xóa ô",
        "overlay.copy": "Sao chép ô",
        "overlay.paste": "Dán ô",
        "shortcuts.zoom": "<strong>Cuộn</strong>: Phóng/thu",
        "shortcuts.pan": "<strong>Space + Kéo</strong>: Di chuyển",
        "shortcuts.delete": "<strong>Delete</strong>: Xóa ô",
        "shortcuts.nudge": "<strong>Mũi tên</strong>: Dịch 1px",
        "intro.title": "Tải ảnh để bắt đầu",
        "intro.subtitle": "Hỗ trợ mọi kích thước ảnh",
        "confirm.applyGrid": "Thay đổi lưới sẽ đặt lại vị trí các sprite. Tiếp tục?",
        "confirm.deleteCell": "Xóa ô này và dồn các ô sau lên để lấp chỗ trống?",
        "confirm.resetAll": "Đặt lại toàn bộ vị trí về mặc định?",
        "confirm.clearHistory": "Xóa toàn bộ lịch sử?",
        "history.load": "Tải ảnh",
        "history.move": "Di chuyển",
        "history.scale": "Tỉ lệ",
        "history.resetCell": "Đặt lại ô",
        "history.reorder": "Sắp xếp",
        "history.deleteCell": "Xóa ô",
        "history.paste": "Dán ô",
        "history.empty": "Chưa có lịch sử",
        "history.applyGrid": "Áp dụng lưới",
        "history.resetAll": "Đặt lại tất cả",
        "labels.language": "Ngôn ngữ",
        "labels.history": "Lịch sử",
        "iso.gridTitle": "Số ô lưới (VD: 6x6)",
        "aria.languageSelect": "Ngôn ngữ",
        "aria.historyList": "Danh sách lịch sử",
        "aria.undo": "Hoàn tác",
        "aria.redo": "Làm lại",
        "aria.orderHistory": "Sắp xếp lịch sử",
        "aria.clearHistory": "Xóa lịch sử",
        "aria.resetCell": "Đặt lại ô",
        "aria.copyCell": "Sao chép ô",
        "aria.pasteCell": "Dán ô",
        "aria.deleteCell": "Xóa ô",
        "aria.reorderCell": "Sắp xếp ô",
    },
    "zh-CN": {
        "app.pageTitle": "精灵表对齐器（像素模式）",
        "app.title": "精灵对齐器",
        "buttons.uploadImage": "上传图片",
        "labels.columns": "列 (C)",
        "labels.rows": "行 (R)",
        "buttons.set": "设置",
        "labels.iso": "等角网格",
        "labels.grid": "网格",
        "labels.width": "宽度",
        "labels.height": "高度",
        "labels.anchor": "锚点",
        "labels.anchorMode": "模式",
        "labels.anchorRatio": "比例",
        "labels.anchorPixel": "像素 (px)",
        "labels.anchorXTitle": "X 锚点（比例或 px）",
        "labels.anchorYTitle": "Y 锚点（比例或 px）",
        "buttons.update": "更新",
        "buttons.undo": "撤销",
        "buttons.redo": "重做",
        "buttons.orderHistoryNewest": "排序：最新在前",
        "buttons.orderHistoryOldest": "排序：最旧在前",
        "buttons.clearHistory": "清空历史",
        "labels.pixelMode": "像素模式",
        "labels.showShortcuts": "显示快捷键",
        "buttons.resetAll": "全部重置",
        "buttons.export": "导出",
        "menu.edit": "编辑单元",
        "menu.copy": "复制单元",
        "menu.paste": "粘贴单元",
        "editor.title": "编辑单元",
        "editor.pan": "平移",
        "editor.pencil": "铅笔",
        "editor.eraser": "橡皮",
        "editor.fill": "填充",
        "editor.select": "矩形选择",
        "editor.color": "颜色",
        "editor.colorRight": "右键颜色",
        "editor.size": "大小",
        "editor.size1": "大小 1px",
        "editor.size2": "大小 2px",
        "editor.size3": "大小 3px",
        "editor.size4": "大小 4px",
        "editor.size5": "大小 5px",
        "editor.size6": "大小 6px",
        "editor.size7": "大小 7px",
        "editor.size8": "大小 8px",
        "editor.size9": "大小 9px",
        "editor.palette": "调色板",
        "editor.paletteMode": "调色板",
        "editor.paletteImage": "图片调色板",
        "editor.paletteBasic": "基础",
        "editor.paletteWarm": "暖色",
        "editor.paletteCool": "冷色",
        "editor.palettePastel": "粉彩",
        "editor.paletteMono": "单色",
        "editor.patterns": "填充图案",
        "editor.shapes": "图形",
        "editor.save": "保存",
        "editor.undo": "撤销",
        "editor.redo": "重做",
        "editor.maximize": "最大化",
        "editor.restore": "还原",
        "editor.cancel": "取消",
        "editor.deleteSelection": "删除选区",
        "history.edit": "编辑单元",
        "overlay.resetCell": "重置",
        "overlay.reorder": "拖动以重排",
        "overlay.delete": "删除单元",
        "overlay.copy": "复制单元",
        "overlay.paste": "粘贴单元",
        "shortcuts.zoom": "<strong>滚轮</strong>：缩放视图",
        "shortcuts.pan": "<strong>空格 + 拖动</strong>：平移视图",
        "shortcuts.delete": "<strong>Delete</strong>：删除单元",
        "shortcuts.nudge": "<strong>方向键</strong>：微移 1px",
        "intro.title": "上传图片开始",
        "intro.subtitle": "支持任意尺寸图片",
        "confirm.applyGrid": "更改网格将重置精灵位置。继续？",
        "confirm.deleteCell": "删除该单元并将后续单元前移填充？",
        "confirm.resetAll": "将所有位置重置为默认值？",
        "confirm.clearHistory": "清空所有历史记录？",
        "history.load": "加载图片",
        "history.move": "移动",
        "history.scale": "缩放",
        "history.resetCell": "重置单元",
        "history.reorder": "重排",
        "history.deleteCell": "删除单元",
        "history.paste": "粘贴单元",
        "history.empty": "暂无历史记录",
        "history.applyGrid": "应用网格",
        "history.resetAll": "全部重置",
        "labels.language": "语言",
        "labels.history": "历史",
        "iso.gridTitle": "网格大小（例如 6x6）",
        "aria.languageSelect": "语言",
        "aria.historyList": "历史列表",
        "aria.undo": "撤销",
        "aria.redo": "重做",
        "aria.orderHistory": "排序历史",
        "aria.clearHistory": "清空历史",
        "aria.resetCell": "重置单元",
        "aria.copyCell": "复制单元",
        "aria.pasteCell": "粘贴单元",
        "aria.deleteCell": "删除单元",
        "aria.reorderCell": "重排单元",
    },
    "zh-TW": {
        "app.pageTitle": "精靈表對齊器（像素模式）",
        "app.title": "精靈對齊器",
        "buttons.uploadImage": "上傳圖片",
        "labels.columns": "欄 (C)",
        "labels.rows": "行 (R)",
        "buttons.set": "設定",
        "labels.iso": "等角網格",
        "labels.grid": "網格",
        "labels.width": "寬度",
        "labels.height": "高度",
        "labels.anchor": "錨點",
        "labels.anchorMode": "模式",
        "labels.anchorRatio": "比例",
        "labels.anchorPixel": "像素 (px)",
        "labels.anchorXTitle": "X 錨點（比例或 px）",
        "labels.anchorYTitle": "Y 錨點（比例或 px）",
        "buttons.update": "更新",
        "buttons.undo": "復原",
        "buttons.redo": "重做",
        "buttons.orderHistoryNewest": "排序：最新在前",
        "buttons.orderHistoryOldest": "排序：最舊在前",
        "buttons.clearHistory": "清除歷史",
        "labels.pixelMode": "像素模式",
        "labels.showShortcuts": "顯示快捷鍵",
        "buttons.resetAll": "全部重置",
        "buttons.export": "匯出",
        "menu.edit": "編輯儲存格",
        "menu.copy": "複製儲存格",
        "menu.paste": "貼上儲存格",
        "editor.title": "編輯儲存格",
        "editor.pan": "平移",
        "editor.pencil": "鉛筆",
        "editor.eraser": "橡皮擦",
        "editor.fill": "填色",
        "editor.select": "矩形選取",
        "editor.color": "顏色",
        "editor.colorRight": "右鍵顏色",
        "editor.size": "大小",
        "editor.size1": "大小 1px",
        "editor.size2": "大小 2px",
        "editor.size3": "大小 3px",
        "editor.size4": "大小 4px",
        "editor.size5": "大小 5px",
        "editor.size6": "大小 6px",
        "editor.size7": "大小 7px",
        "editor.size8": "大小 8px",
        "editor.size9": "大小 9px",
        "editor.palette": "調色盤",
        "editor.paletteMode": "調色盤",
        "editor.paletteImage": "圖片調色盤",
        "editor.paletteBasic": "基礎",
        "editor.paletteWarm": "暖色",
        "editor.paletteCool": "冷色",
        "editor.palettePastel": "粉彩",
        "editor.paletteMono": "單色",
        "editor.patterns": "填充圖案",
        "editor.shapes": "圖形",
        "editor.save": "儲存",
        "editor.undo": "復原",
        "editor.redo": "重做",
        "editor.maximize": "最大化",
        "editor.restore": "還原",
        "editor.cancel": "取消",
        "editor.deleteSelection": "刪除選取",
        "history.edit": "編輯儲存格",
        "overlay.resetCell": "重置",
        "overlay.reorder": "拖曳以重新排序",
        "overlay.delete": "刪除儲存格",
        "overlay.copy": "複製儲存格",
        "overlay.paste": "貼上儲存格",
        "shortcuts.zoom": "<strong>滾輪</strong>：縮放檢視",
        "shortcuts.pan": "<strong>空白鍵 + 拖曳</strong>：平移檢視",
        "shortcuts.delete": "<strong>Delete</strong>：刪除儲存格",
        "shortcuts.nudge": "<strong>方向鍵</strong>：微移 1px",
        "intro.title": "上傳圖片開始",
        "intro.subtitle": "支援任何尺寸圖片",
        "confirm.applyGrid": "變更網格會重置精靈位置。繼續？",
        "confirm.deleteCell": "刪除此儲存格並將後續儲存格前移填補？",
        "confirm.resetAll": "將所有位置重置為預設值？",
        "confirm.clearHistory": "清除所有歷史紀錄？",
        "history.load": "載入圖片",
        "history.move": "移動",
        "history.scale": "縮放",
        "history.resetCell": "重置儲存格",
        "history.reorder": "重新排序",
        "history.deleteCell": "刪除儲存格",
        "history.paste": "貼上儲存格",
        "history.empty": "尚無歷史紀錄",
        "history.applyGrid": "套用網格",
        "history.resetAll": "全部重置",
        "labels.language": "語言",
        "labels.history": "歷史",
        "iso.gridTitle": "網格大小（例如 6x6）",
        "aria.languageSelect": "語言",
        "aria.historyList": "歷史清單",
        "aria.undo": "復原",
        "aria.redo": "重做",
        "aria.orderHistory": "排序歷史",
        "aria.clearHistory": "清除歷史",
        "aria.resetCell": "重置儲存格",
        "aria.copyCell": "複製儲存格",
        "aria.pasteCell": "貼上儲存格",
        "aria.deleteCell": "刪除儲存格",
        "aria.reorderCell": "重新排序",
    },
    "fr": {
        "app.pageTitle": "Aligneur de Sprites (Mode Pixel)",
        "app.title": "Aligneur Sprite",
        "buttons.uploadImage": "Importer une image",
        "labels.columns": "Colonnes (C)",
        "labels.rows": "Lignes (R)",
        "buttons.set": "Définir",
        "labels.iso": "Grille isométrique",
        "labels.grid": "Grille",
        "labels.width": "Largeur",
        "labels.height": "Hauteur",
        "labels.anchor": "Point d'ancrage",
        "labels.anchorMode": "Mode",
        "labels.anchorRatio": "Ratio",
        "labels.anchorPixel": "Pixel (px)",
        "labels.anchorXTitle": "Ancrage X (ratio ou px)",
        "labels.anchorYTitle": "Ancrage Y (ratio ou px)",
        "buttons.update": "Mettre à jour",
        "buttons.undo": "Annuler",
        "buttons.redo": "Rétablir",
        "buttons.orderHistoryNewest": "Trier : plus récent d'abord",
        "buttons.orderHistoryOldest": "Trier : plus ancien d'abord",
        "buttons.clearHistory": "Effacer l'historique",
        "labels.pixelMode": "Mode Pixel",
        "labels.showShortcuts": "Afficher les raccourcis",
        "buttons.resetAll": "Tout réinitialiser",
        "buttons.export": "Exporter",
        "menu.edit": "Éditer la cellule",
        "menu.copy": "Copier la cellule",
        "menu.paste": "Coller la cellule",
        "editor.title": "Éditer la cellule",
        "editor.pan": "Déplacer",
        "editor.pencil": "Crayon",
        "editor.eraser": "Gomme",
        "editor.fill": "Remplir",
        "editor.select": "Sélection",
        "editor.color": "Couleur",
        "editor.colorRight": "Couleur droite",
        "editor.size": "Taille",
        "editor.size1": "Taille 1px",
        "editor.size2": "Taille 2px",
        "editor.size3": "Taille 3px",
        "editor.size4": "Taille 4px",
        "editor.size5": "Taille 5px",
        "editor.size6": "Taille 6px",
        "editor.size7": "Taille 7px",
        "editor.size8": "Taille 8px",
        "editor.size9": "Taille 9px",
        "editor.palette": "Palette",
        "editor.paletteMode": "Palette",
        "editor.paletteImage": "Palette image",
        "editor.paletteBasic": "Basique",
        "editor.paletteWarm": "Chaud",
        "editor.paletteCool": "Froid",
        "editor.palettePastel": "Pastel",
        "editor.paletteMono": "Mono",
        "editor.patterns": "Motifs de remplissage",
        "editor.shapes": "Formes",
        "editor.save": "Enregistrer",
        "editor.undo": "Annuler",
        "editor.redo": "Rétablir",
        "editor.maximize": "Agrandir",
        "editor.restore": "Restaurer",
        "editor.cancel": "Annuler",
        "editor.deleteSelection": "Supprimer la sélection",
        "history.edit": "Éditer la cellule",
        "overlay.resetCell": "Réinitialiser",
        "overlay.reorder": "Glisser pour réordonner",
        "overlay.delete": "Supprimer la cellule",
        "overlay.copy": "Copier la cellule",
        "overlay.paste": "Coller la cellule",
        "shortcuts.zoom": "<strong>Molette</strong> : Zoom",
        "shortcuts.pan": "<strong>Espace + Glisser</strong> : Déplacer",
        "shortcuts.delete": "<strong>Suppr</strong> : Supprimer la cellule",
        "shortcuts.nudge": "<strong>Flèches</strong> : Déplacer 1px",
        "intro.title": "Importez une image pour commencer",
        "intro.subtitle": "Prend en charge toutes les tailles d'image",
        "confirm.applyGrid": "Changer la grille réinitialisera les positions des sprites. Continuer ?",
        "confirm.deleteCell": "Supprimer cette cellule et décaler les suivantes pour remplir ?",
        "confirm.resetAll": "Réinitialiser toutes les positions par défaut ?",
        "confirm.clearHistory": "Effacer tout l'historique ?",
        "history.load": "Charger l'image",
        "history.move": "Déplacer",
        "history.scale": "Redimensionner",
        "history.resetCell": "Réinitialiser la cellule",
        "history.reorder": "Réordonner",
        "history.deleteCell": "Supprimer la cellule",
        "history.paste": "Coller la cellule",
        "history.empty": "Aucun historique",
        "history.applyGrid": "Appliquer la grille",
        "history.resetAll": "Tout réinitialiser",
        "labels.language": "Langue",
        "labels.history": "Historique",
        "iso.gridTitle": "Taille de la grille (ex. 6x6)",
        "aria.languageSelect": "Langue",
        "aria.historyList": "Liste d'historique",
        "aria.undo": "Annuler",
        "aria.redo": "Rétablir",
        "aria.orderHistory": "Trier l'historique",
        "aria.clearHistory": "Effacer l'historique",
        "aria.resetCell": "Réinitialiser la cellule",
        "aria.copyCell": "Copier la cellule",
        "aria.pasteCell": "Coller la cellule",
        "aria.deleteCell": "Supprimer la cellule",
        "aria.reorderCell": "Réordonner la cellule",
    },
    "ru": {
        "app.pageTitle": "Выравнивание Спрайт-листов (Пиксельный режим)",
        "app.title": "Выравниватель спрайтов",
        "buttons.uploadImage": "Загрузить изображение",
        "labels.columns": "Колонки (C)",
        "labels.rows": "Ряды (R)",
        "buttons.set": "Установить",
        "labels.iso": "Изометрическая сетка",
        "labels.grid": "Сетка",
        "labels.width": "Ширина",
        "labels.height": "Высота",
        "labels.anchor": "Точка привязки",
        "labels.anchorMode": "Режим",
        "labels.anchorRatio": "Пропорция",
        "labels.anchorPixel": "Пиксели (px)",
        "labels.anchorXTitle": "Привязка X (пропорция или px)",
        "labels.anchorYTitle": "Привязка Y (пропорция или px)",
        "buttons.update": "Обновить",
        "buttons.undo": "Отменить",
        "buttons.redo": "Повторить",
        "buttons.orderHistoryNewest": "Сортировка: новые сверху",
        "buttons.orderHistoryOldest": "Сортировка: старые сверху",
        "buttons.clearHistory": "Очистить историю",
        "labels.pixelMode": "Пиксельный режим",
        "labels.showShortcuts": "Показать горячие клавиши",
        "buttons.resetAll": "Сбросить всё",
        "buttons.export": "Экспорт",
        "menu.edit": "Редактировать ячейку",
        "menu.copy": "Копировать ячейку",
        "menu.paste": "Вставить ячейку",
        "editor.title": "Редактировать ячейку",
        "editor.pan": "Панорама",
        "editor.pencil": "Карандаш",
        "editor.eraser": "Ластик",
        "editor.fill": "Заливка",
        "editor.select": "Выделение",
        "editor.color": "Цвет",
        "editor.colorRight": "Цвет справа",
        "editor.size": "Размер",
        "editor.size1": "Размер 1px",
        "editor.size2": "Размер 2px",
        "editor.size3": "Размер 3px",
        "editor.size4": "Размер 4px",
        "editor.size5": "Размер 5px",
        "editor.size6": "Размер 6px",
        "editor.size7": "Размер 7px",
        "editor.size8": "Размер 8px",
        "editor.size9": "Размер 9px",
        "editor.palette": "Палитра",
        "editor.paletteMode": "Палитра",
        "editor.paletteImage": "Палитра изображения",
        "editor.paletteBasic": "Базовая",
        "editor.paletteWarm": "Теплая",
        "editor.paletteCool": "Холодная",
        "editor.palettePastel": "Пастель",
        "editor.paletteMono": "Моно",
        "editor.patterns": "Узоры заливки",
        "editor.shapes": "Фигуры",
        "editor.save": "Сохранить",
        "editor.undo": "Отменить",
        "editor.redo": "Повторить",
        "editor.maximize": "Развернуть",
        "editor.restore": "Восстановить",
        "editor.cancel": "Отмена",
        "editor.deleteSelection": "Удалить выделение",
        "history.edit": "Редактировать ячейку",
        "overlay.resetCell": "Сбросить",
        "overlay.reorder": "Перетащить для сортировки",
        "overlay.delete": "Удалить ячейку",
        "overlay.copy": "Копировать ячейку",
        "overlay.paste": "Вставить ячейку",
        "shortcuts.zoom": "<strong>Колесо</strong>: Масштаб",
        "shortcuts.pan": "<strong>Пробел + Перетаскивание</strong>: Панорама",
        "shortcuts.delete": "<strong>Delete</strong>: Удалить ячейку",
        "shortcuts.nudge": "<strong>Стрелки</strong>: Сдвиг на 1px",
        "intro.title": "Загрузите изображение, чтобы начать",
        "intro.subtitle": "Поддерживаются изображения любого размера",
        "confirm.applyGrid": "Изменение сетки сбросит позиции спрайтов. Продолжить?",
        "confirm.deleteCell": "Удалить эту ячейку и сдвинуть последующие для заполнения?",
        "confirm.resetAll": "Сбросить все позиции по умолчанию?",
        "confirm.clearHistory": "Очистить всю историю?",
        "history.load": "Загрузить изображение",
        "history.move": "Переместить",
        "history.scale": "Масштаб",
        "history.resetCell": "Сброс ячейки",
        "history.reorder": "Сортировка",
        "history.deleteCell": "Удалить ячейку",
        "history.paste": "Вставить ячейку",
        "history.empty": "История пуста",
        "history.applyGrid": "Применить сетку",
        "history.resetAll": "Сбросить всё",
        "labels.language": "Язык",
        "labels.history": "История",
        "iso.gridTitle": "Размер сетки (например, 6x6)",
        "aria.languageSelect": "Язык",
        "aria.historyList": "Список истории",
        "aria.undo": "Отменить",
        "aria.redo": "Повторить",
        "aria.orderHistory": "Сортировать историю",
        "aria.clearHistory": "Очистить историю",
        "aria.resetCell": "Сбросить ячейку",
        "aria.copyCell": "Копировать ячейку",
        "aria.pasteCell": "Вставить ячейку",
        "aria.deleteCell": "Удалить ячейку",
        "aria.reorderCell": "Переместить ячейку",
    },
};

let currentLocale: Locale = DEFAULT_LOCALE;

function isLocale(value: string | null): value is Locale {
    return !!value && LOCALES.includes(value as Locale);
}

export function findTranslationKey(value: string, keys: string[]): string | undefined {
    for (const locale of LOCALES) {
        const table = TRANSLATIONS[locale];
        for (const key of keys) {
            if (table?.[key] === value) return key;
        }
    }
    return undefined;
}

function resolveInitialLocale(): Locale {
    const saved = localStorage.getItem(STORAGE_KEY);
    return isLocale(saved) ? saved : DEFAULT_LOCALE;
}

function translate(key: string): string {
    return TRANSLATIONS[currentLocale]?.[key] ?? TRANSLATIONS[DEFAULT_LOCALE][key] ?? key;
}

function applyTranslations(root: ParentNode = document): void {
    root.querySelectorAll<HTMLElement>("[data-i18n]").forEach((el) => {
        const key = el.dataset.i18n;
        if (!key) return;
        el.textContent = translate(key);
    });

    root.querySelectorAll<HTMLElement>("[data-i18n-html]").forEach((el) => {
        const key = el.dataset.i18nHtml;
        if (!key) return;
        el.innerHTML = translate(key);
    });

    root.querySelectorAll<HTMLElement>("[data-i18n-title]").forEach((el) => {
        const key = el.dataset.i18nTitle;
        if (!key) return;
        el.setAttribute("title", translate(key));
    });

    root.querySelectorAll<HTMLElement>("[data-i18n-aria]").forEach((el) => {
        const key = el.dataset.i18nAria;
        if (!key) return;
        el.setAttribute("aria-label", translate(key));
    });

    document.title = translate("app.pageTitle");
    document.documentElement.lang = currentLocale;
}

function setLocale(locale: Locale): void {
    currentLocale = locale;
    localStorage.setItem(STORAGE_KEY, locale);
}

function setLanguageSelect(select: HTMLSelectElement, onChange?: () => void): void {
    select.innerHTML = "";
    LANGUAGE_OPTIONS.forEach((option) => {
        const opt = document.createElement("option");
        opt.value = option.code;
        opt.textContent = option.label;
        select.appendChild(opt);
    });

    select.value = currentLocale;

    select.addEventListener("change", () => {
        if (isLocale(select.value)) {
            setLocale(select.value);
            applyTranslations();
            if (onChange) onChange();
        }
    });
}

export function createI18n(): I18nApi {
    currentLocale = resolveInitialLocale();
    setLocale(currentLocale);

    return {
        t: translate,
        getLocale: () => currentLocale,
        setLocale,
        applyTranslations,
        setLanguageSelect,
    };
}
